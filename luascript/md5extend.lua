
local cjson = require "cjson"
local md5 = require "md5"

local function read_file(file_name)
    if not file_name then
        return nil, "missing file_name"
    end
    local file = io.open(file_name,'r')
    if not file then
        return nil, "can\'t open file \"" .. file_name .. "\""
    end
    local content = file:read('*all')
    file:close()
    return content, nil
end

--get params
if "GET" == ngx.var.request_method then
    local hash = ngx.req.get_uri_args()["hash"]
    local username = ngx.req.get_uri_args()["username"]
    local flag = ngx.req.get_uri_args()["flag"]
    if hash == nil then
        hash = ""
    end
    if username == nil then
        username = ""
    end
    if flag == nil then
        flag = 1
    end
    if flag == 1 then
        ngx.say([[<html>
    <head>
        <meta charset="UTF-8">
        <title>Lua-vulnerability</title>
    </head>
    <body>
        <h1>MD5 长度扩展攻击 demo </h1>
        介绍：<br>
        提交两个参数 username 和 hash（提示都可为空），如果 md5(key + timestamp + username) == hash，则鉴权通过，获得 flag<br><br>
        请输入 username: &nbsp;&nbsp;<input type="text" id="username" value="" size="40"><br>
        请输入 hash: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <input type="text" id="hash" value="" size="40"><br>
        <a href="javascript:void(0)" onclick="query()">确定</a>
        <br>
        <a href="javascript:void(0)" onclick="source()">查看lua源码</a>
        <div id="result"></div>
        <script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
        <script>
                 function query() {
                     var hash = $('#hash').val()
                     var username = $('#username').val()
                     $.ajax({
                         type: "get",
                         url: "/md5-extend?hash="+hash+"&username="+username+"&flag=0",
                         dataType: "text",
                         success: function (res) {
                         $("#result").html(res);

                         }
                     });
                 }
            function source() {
                $.ajax({
                    type: "post",
                    url: "/md5-extend",
                    dataType: "text",
                    contentType: 'application/json',
                    data:JSON.stringify({"source":"1"}),
                    success: function (res) {
                    $("#result").html(res);
                    }
                });
            }
        </script>
    </body>
    </html>]])
    else
        local key = "q[azddxz.123]a"
        local timestamp = ngx.time()
        local cipher1 = md5.sumhexa(key .. timestamp .. username)
        --local cipher1 = md5.sumhexa(key .. username)
        ngx.say(cipher1)
        if cipher1 == hash then
            local content, err = read_file("/flag")
            ngx.say(content)
        else
            ngx.say("error")
        end
    end
elseif "POST" == ngx.var.request_method then
    local args = ngx.req.get_body_data()
    local obj = cjson.new().decode(args)
    local source = obj["source"]
    --local username = obj["username"]
    --local hash = obj["hash"]
    if source ~=nil then
    local content = [[
            local username = ngx.req.get_uri_args()["username"] <br>
            local hash = ngx.req.get_uri_args()["hash"]<br>
            if username == nil then<br>
                &nbsp;&nbsp;&nbsp;&nbsp;username = ""<br>
            end<br>
            local key = "**************" <br>
            local timestamp = ngx.time() <br>
            local cipher1 = md5.sumhexa(key .. timestamp .. username)<br>
            ngx.say(cipher1)<br>
            if cipher1 == hash then<br>
                &nbsp;&nbsp;&nbsp;&nbsp;local content, err = read_file("/flag")<br>
                &nbsp;&nbsp;&nbsp;&nbsp;ngx.say(content)<br>
            else<br>
                &nbsp;&nbsp;&nbsp;&nbsp;ngx.say("error")<br>
            end<br>
                ]]
    ngx.say(content)
    end
end
