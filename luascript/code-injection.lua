
local cjson = require "cjson"

--get params
if "GET" == ngx.var.request_method then
    ngx.say([[<html>
<head>
    <meta charset="UTF-8">
    <title>Lua-vulnerability</title>
</head>
<body>
    <h1>代码注入 demo </h1>
    请输入 lua 代码: &nbsp;&nbsp;&nbsp;<input type="text" id="code" value="ngx.say('Hello lockcy')" size="20"><br>
    <a href="javascript:void(0)" onclick="query()">确定</a>
    <br>
    <a href="javascript:void(0)" onclick="source()">查看lua源码</a>
    <div id="result"></div>
    <script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <script>
        function query() {
            var code = $('#code').val()
            $.ajax({
                type: "post",
                url: "/code-injection",
                dataType: "text",
		contentType: 'application/json',
                data:JSON.stringify({"code":code}),
                success: function (res) {
	            $("#result").html(res);

                }
            });
		}
        function source() {
            $.ajax({
                type: "post",
                url: "/code-injection",
                dataType: "text",
		contentType: 'application/json',
                data:JSON.stringify({"source":"1"}),
                success: function (res) {
	            $("#result").html(res);
                }
            });
		}
    </script>
</body>
</html>]])
elseif "POST" == ngx.var.request_method then
    local args = ngx.req.get_body_data()
    local obj = cjson.new().decode(args)
    local source = obj["source"]
    local code = obj["code"]
    if source ~=nil then
        local content = [[
            if code == nil or #code==0 then<br>
            &nbsp;&nbsp;&nbsp;&nbsp;code = "ngx.say('Hello lockcy')"<br>
            end<br>
            local res,err = pcall(function()<br>
            &nbsp;&nbsp;&nbsp;&nbsp;loadstring(code)()<br>
            end)<br>
            if err ~=nil then<br>
            &nbsp;&nbsp;&nbsp;&nbsp;ngx.say(err)<br>
            end<br>
            ]]
        ngx.say(content)
    else
        if code == nil or #code==0 then
            code = "ngx.say('Hello lockcy')"
        end
        local res,err = pcall(function()
            loadstring(code)()
        end)
        if err ~=nil then
            ngx.say(err)
        end
    end
end



