
FROM ubuntu:16.04

MAINTAINER lockcy <lockcysec@qq.com>

ENV WORK_PATH /usr/local/work

ENV INSTALL_PATH /usr/servers

ENV NGX_OPENRESTY_PACKAGE_NAME openresty-1.19.9.1

RUN mkdir -p $WORK_PATH
RUN mkdir -p $INSTALL_PATH

RUN sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list &&\
    sed -i s@/security.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list &&\
    apt clean &&\
    apt-get update -y

# install lib
RUN apt-get install -y make gcc libreadline-dev libncurses5-dev libpcre3-dev libssl-dev perl

COPY ./$NGX_OPENRESTY_PACKAGE_NAME $INSTALL_PATH/$NGX_OPENRESTY_PACKAGE_NAME

#RUN cd $INSTALL_PATH/$NGX_OPENRESTY_PACKAGE_NAME/bundle/LuaJIT-2.1-20210510/ && make clean && make && make install
#RUN ln -sf luajit-2.1.0-alpha /usr/local/bin/luajit

# ./configure
#RUN cd $INSTALL_PATH/$NGX_OPENRESTY_PACKAGE_NAME && ./configure --prefix=$INSTALL_PATH --with-http_realip_module  --with-pcre  --with-luajit --add-module=./bundle/$NGX_CACHE_PURGE_PACKAGE_NAME/ --add-module=./bundle/$NGX_UPSTREAM_CHECK_PACKAGE_NAME/ -j2 && make && make install
RUN cd $INSTALL_PATH/$NGX_OPENRESTY_PACKAGE_NAME && ./configure --prefix=$INSTALL_PATH -j2 && make && make install

# replace nginx.conf
RUN rm $INSTALL_PATH/nginx/conf/nginx.conf
COPY ./conf/nginx.conf $INSTALL_PATH/nginx/conf/

# lualib
RUN mkdir $WORK_PATH/lualib
COPY ./lib $WORK_PATH/lualib

# lua script
RUN mkdir $WORK_PATH/lua
RUN mkdir $WORK_PATH/files
RUN echo "this is an example file" > $WORK_PATH/files/example.txt
RUN echo "flag{lua_vulner4bility_i3_funny}" > /flag

COPY ./luascript/*.lua $WORK_PATH/lua/

# mysql
RUN echo "mysql-server mysql-server/root_password password root" | debconf-set-selections &&\
echo "mysql-server mysql-server/root_password_again password root" | debconf-set-selections &&\
apt-get install -y mysql-server

ADD ./conf/run.sh /home/
RUN chmod +x /home/run.sh
EXPOSE 9000

CMD ["/home/run.sh"]




